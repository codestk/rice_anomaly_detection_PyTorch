#include <Servo.h>

Servo gateServo;

constexpr byte SERVO_PIN = 9;

constexpr int DEFAULT_OPEN_ANGLE = 180;
constexpr int DEFAULT_CLOSE_ANGLE = 0;

int openAngle = DEFAULT_OPEN_ANGLE;
int closeAngle = DEFAULT_CLOSE_ANGLE;

String incoming;

void moveServo(int angle) {
angle = constrain(angle, 0, 180);
gateServo.write(angle);
}

void sendAck(const char *label, int angle) {
Serial.print("Servo -> ");
Serial.print(label);
Serial.print(" @ ");
Serial.println(angle);
}

void commandOpen(int angle) {
moveServo(angle);
sendAck("OPEN", angle);
}

void commandClose(int angle) {
moveServo(angle);
sendAck("CLOSE", angle);
}

bool tryParseAngle(const String &token, int &angleOut) {
if (token.length() == 0) return false;
char c0 = token[0];
if ((c0 < '0' || c0 > '9') && c0 != '+' && c0 != '-') return false;
angleOut = constrain(token.toInt(), 0, 180);
return true;
}

void handleCommand(const String &cmdRaw) {
if (cmdRaw.length() == 0) return;

String cmd = cmdRaw;
cmd.trim();

int spacePos = cmd.indexOf(' ');
String verb = spacePos == -1 ? cmd : cmd.substring(0, spacePos);
String arg = spacePos == -1 ? "" : cmd.substring(spacePos + 1);
arg.trim();

String verbUpper = verb;
verbUpper.toUpperCase();

int angle = 0;
bool hasAngle = tryParseAngle(arg, angle);

if (verbUpper == "1" || verbUpper == "OPEN") {
commandOpen(hasAngle ? angle : openAngle);
} else if (verbUpper == "0" || verbUpper == "CLOSE") {
commandClose(hasAngle ? angle : closeAngle);
} else if (verbUpper == "SETOPEN" && hasAngle) {
openAngle = angle;
Serial.print("Open angle stored: ");
Serial.println(openAngle);
} else if (verbUpper == "SETCLOSE" && hasAngle) {
closeAngle = angle;
Serial.print("Close angle stored: ");
Serial.println(closeAngle);
} else if (tryParseAngle(cmd, angle)) {
moveServo(angle);
sendAck("MOVE", angle);
} else {
Serial.print("Unknown cmd: ");
Serial.println(cmd);
}
}

void setup() {
gateServo.attach(SERVO_PIN);
moveServo(DEFAULT_CLOSE_ANGLE);

Serial.begin(9600);
Serial.setTimeout(100);
Serial.println("Servo controller ready.");
}

void loop() {
if (Serial.available()) {
incoming = Serial.readStringUntil('\n');
incoming.trim();
handleCommand(incoming);
}
} 